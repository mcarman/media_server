
version: '3.9'

#####
# Common Configs
##### 
##  environment: 
#    PUID: "${PUID:-1000}" 
#    PGID: "${PGID:-1000}"
#    TZ: "${TZ:-Etc/UTC}"

#x-logging: &logging_def
#    driver: "json-file"
#    options:
#      max-size: "10m"
#      max-file: "3"
#      compress: "true"

#x-healthcheck:
#  healthcheck:
#    test: [ "CMD", "curl", "-f", "http://localhost:8080" ]
#    interval: 1m30s
#    timeout: 10s
#    retries: 3
#    start_period: 40s


#####
# project name
#####
name: media_server

#####
# services section
#####
services:

  ###
  # Portainer - Manage docker contsainers and stack
  ###
  portainer:
    image: portainer/portainer-ce:linux-arm64
    container_name: portainer
    hostname: $HOSTNAME
    environment:
      PUID: "${PUID:-1000}"
      PGID: "${PGID:-1000}"
      TZ:   "${TZ:-Etc/UTC}"
    networks:
      - media_net
    ports:
      - "9000:9000"
      - "9443:9443"
    volumes:
      - "/var/lib/docker:/var/lib/docker"
      - "portainer_data:/data"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - "/etc/timezone:/etc/timezone:ro"
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  ###
  # Plex- Media Server
  ###  
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    hostname: $HOSTNAME
    environment:
      PLEX_UID: "${PUID:-1000}"
      PLEX_GID: "${PGID:-1000}"
      TZ:       "${TZ:-Etc/UTC}"
      VERSION:  "${PLEX_VERSION:-docker}"
      PLEX_CLAIM: "${PLEX_CLAIM}"
      PLEX_ADVERTISE_IP: "${HOST_IP}:32400"
      # - advertize IP
    networks:
      - media_net
    ports:
      - "32400:32400/tcp"
      - "3005:3005/tcp"
      - "8324:8324/tcp"
      - "32469:32469/tcp"
      - "1900:1900/udp"
      - "32410:32410/udp"
      - "32412:32412/udp"
      - "32413:32413/udp"
      - "32414:32414/udp"
    volumes:
      - "./media/disc1/media/Movies:/movies"
      - "./media/disc1/media/tv:/tv"
      - "/var/lib/docker:/var/lib/docker"
      - "plex_data:/config"
      - "./apps/plex/config/Preferences.xml:$PLEX_PREF"
      - "/etc/localtime:/etc/localtime:ro"
      - "/etc/timezone:/etc/timezone:ro"
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
  
  ###
  #  tautulli - Utilities for Plex
  ###
  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    hostname: $HOSTNAME
    depends_on:
      plex:
        condition: service_started
    environment:
      PUID: "${PUID:-1000}"
      PGID: "${PGID:-1000}"
      TZ:   "${TZ:-Etc/UTC}"
      GUID: "${GUID:-1000}"
    networks:
      - media_net
    ports:
      - "8181:8181"
    volumes:
      - "./apps/tautulli/config:/config"
      - "./apps/plex/logs:/plexlogs"
      - "/etc/localtime:/etc/localtime:ro"
      - "/etc/timezone:/etc/timezone:ro"
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

    

#####
# Volumes section
#####
volumes:
  portainer_data:
    external: true
  plex_data:
    external: true
#  pp_data:
#    external: true
#  pp_media:
#    external: true
#  pp_pg_data:
#    external: true
#  pp_redis_data:
#    external: true

####
# Networks 
###
networks:
  media_net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.5.0.0/24
          gateway: 10.5.0.1

